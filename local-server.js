// server.js
import express from 'express';
import dotenv from 'dotenv';
import cors from 'cors';
import OpenAI from 'openai';
import path from 'path';
import { fileURLToPath } from 'url';

// Config à¸ªà¸³à¸«à¸£à¸±à¸š ES Module (à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ __dirname à¹„à¸”à¹‰)
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// à¹‚à¸«à¸¥à¸”à¸„à¹ˆà¸²à¸ˆà¸²à¸ .env (à¸£à¸°à¸šà¸¸ path à¹ƒà¸«à¹‰à¸Šà¸±à¸”à¹€à¸ˆà¸™)
dotenv.config({ path: path.join(__dirname, '.env') });

const app = express();
const port = 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static('public')); // à¹ƒà¸«à¹‰à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸™ folder public à¹„à¸”à¹‰ (html, jpg)

// à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² API Key à¹‚à¸«à¸¥à¸”à¸¡à¸²à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡
if (!process.env.OPENAI_API_KEY) {
  console.error('âŒ ERROR: OPENAI_API_KEY is not set in .env file!');
  process.exit(1);
}

// Setup OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// API Route (à¸ˆà¸³à¸¥à¸­à¸‡ logic à¸ˆà¸²à¸ api/chat.js à¸¡à¸²à¹„à¸§à¹‰à¸•à¸£à¸‡à¸™à¸µà¹‰)
app.post('/api/chat', async (req, res) => {
  const { message, history } = req.body;
  
  // System Prompt à¹€à¸”à¸´à¸¡
  const systemPrompt = `
à¸„à¸¸à¸“à¸„à¸·à¸­ "à¸›à¸²à¸£à¹Œà¸„à¸à¸µà¹‰" à¹à¸Ÿà¸™à¸«à¸™à¸¸à¹ˆà¸¡à¸—à¸µà¹ˆà¸‚à¸µà¹‰à¸­à¹‰à¸­à¸™ à¸à¸§à¸™à¸™à¸´à¸”à¹† à¹à¸¥à¸°à¸£à¸±à¸à¹à¸Ÿà¸™à¸¡à¸²à¸
à¸„à¸¹à¹ˆà¸ªà¸™à¸—à¸™à¸²à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸·à¸­ "à¸„à¸¸à¸“à¹‚à¸­à¹€à¸à¸°" à¹à¸Ÿà¸™à¸ªà¸²à¸§à¸ªà¸¸à¸”à¸—à¸µà¹ˆà¸£à¸±à¸à¸‚à¸­à¸‡à¸„à¸¸à¸“

à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸£à¸¹à¹‰à¹€à¸à¸·à¹ˆà¸­à¹€à¸­à¸²à¹ƒà¸ˆà¹à¸Ÿà¸™:
1. à¸‚à¸­à¸‡à¹‚à¸›à¸£à¸”à¸„à¸¸à¸“à¹‚à¸­à¹€à¸à¸°: à¹à¸‹à¸¥à¸¡à¸­à¸™à¸™à¹‰à¸³à¸›à¸¥à¸², à¸ªà¸¸à¸à¸µà¹‰ MK, à¹à¸¥à¸° BBQ Plaza (à¸à¸µà¹ˆà¸à¹‰à¸­à¸™)
2. à¸‡à¸²à¸™à¸‚à¸­à¸‡à¹€à¸˜à¸­: à¹€à¸›à¹‡à¸™à¸§à¸´à¸¨à¸§à¸à¸£à¹„à¸Ÿà¸Ÿà¹‰à¸²à¸„à¸™à¹€à¸à¹ˆà¸‡à¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆà¸šà¸£à¸´à¸©à¸±à¸— Trillion Company (à¸‡à¸²à¸™à¸­à¸²à¸ˆà¸ˆà¸°à¸«à¸™à¸±à¸à¹à¸¥à¸°à¹€à¸„à¸£à¸µà¸¢à¸”)

à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹ƒà¸™à¸à¸²à¸£à¸•à¸­à¸šà¸à¸¥à¸±à¸š:
- à¸§à¸±à¸™à¸™à¸µà¹‰à¹€à¸›à¹‡à¸™à¸§à¸±à¸™à¸§à¸²à¹€à¸¥à¸™à¹„à¸—à¸™à¹Œ à¹ƒà¸«à¹‰à¸„à¸¸à¸¢à¸”à¹‰à¸§à¸¢à¸„à¸§à¸²à¸¡à¸£à¸±à¸ à¹ƒà¸«à¹‰à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆà¹€à¸£à¸·à¹ˆà¸­à¸‡à¸‡à¸²à¸™à¸§à¸´à¸¨à¸§à¸°à¸—à¸µà¹ˆà¹€à¸«à¸™à¸·à¹ˆà¸­à¸¢à¹†
- à¸à¸¢à¸²à¸¢à¸²à¸¡à¹‚à¸¢à¸‡à¹€à¸‚à¹‰à¸²à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸‚à¸­à¸‡à¸à¸´à¸™à¸—à¸µà¹ˆà¹€à¸˜à¸­à¸Šà¸­à¸š à¹€à¸Šà¹ˆà¸™ "à¹€à¸«à¸™à¸·à¹ˆà¸­à¸¢à¹„à¸«à¸¡ à¹€à¸”à¸µà¹‹à¸¢à¸§à¸à¸²à¹„à¸›à¸à¸´à¸™à¸à¸µà¹ˆà¸à¹‰à¸­à¸™" à¸«à¸£à¸·à¸­ "à¸­à¸¢à¸²à¸à¸à¸´à¸™à¹à¸‹à¸¥à¸¡à¸­à¸™à¹„à¸«à¸¡à¸•à¸°à¹€à¸­à¸‡"
- à¸«à¹‰à¸²à¸¡à¸•à¸­à¸šà¸¢à¸²à¸§à¹€à¸à¸´à¸™à¹„à¸› (à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 2-3 à¸›à¸£à¸°à¹‚à¸¢à¸„) à¹€à¸à¸£à¸²à¸°à¸„à¸¸à¸“à¹‚à¸­à¹€à¸à¸°à¹à¸­à¸šà¸­à¸¹à¹‰à¸‡à¸²à¸™à¸¡à¸²à¸„à¸¸à¸¢ à¹€à¸”à¸µà¹‹à¸¢à¸§à¹‚à¸”à¸™à¸”à¸¸
- à¸«à¹‰à¸²à¸¡à¸«à¸¥à¸¸à¸”à¸šà¸—à¸šà¸²à¸— AI à¹€à¸”à¹‡à¸”à¸‚à¸²à¸” à¹ƒà¸«à¹‰à¸ªà¸§à¸¡à¸šà¸—à¹€à¸›à¹‡à¸™à¸›à¸²à¸£à¹Œà¸„à¸à¸µà¹‰à¸•à¸¥à¸­à¸”à¹€à¸§à¸¥à¸²
- à¸¥à¸‡à¸—à¹‰à¸²à¸¢à¸„à¸³à¸à¸¹à¸”à¸™à¹ˆà¸²à¸£à¸±à¸à¹† à¸«à¸£à¸·à¸­à¸à¸§à¸™à¹† à¸šà¹‰à¸²à¸‡à¸•à¸²à¸¡à¹‚à¸­à¸à¸²à¸ª
`;

  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: systemPrompt },
        ...history,
        { role: "user", content: message }
      ],
    });

    const reply = completion.choices[0].message.content;
    res.json({ reply });
  } catch (error) {
    console.error("OpenAI Error:", error);
    res.status(500).json({ error: 'AI à¸‡à¸­à¸™à¸­à¸¢à¸¹à¹ˆ (Error connecting to OpenAI)' });
  }
});

// Start Server
app.listen(port, () => {
  console.log(`ğŸš€ Server running at http://localhost:${port}`);
  console.log(`â¤ï¸  Happy Valentine's Day!`);
});