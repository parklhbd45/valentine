<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>For My Lovely Valentine</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff4d79;
            --secondary: #ffb3c6;
            --bg: #fff0f5;
            --line-color: #06C755;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg);
            text-align: center;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            color: #d63384;
            user-select: none; /* ‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏≥ */
        }

        /* Container ‡∏´‡∏•‡∏±‡∏Å */
        .container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; background: rgba(255, 255, 255, 0.95); padding: 30px;
            border-radius: 30px; box-shadow: 0 20px 60px rgba(255, 77, 121, 0.3);
            transition: opacity 0.5s; backdrop-filter: blur(10px);
            border: 3px solid white; box-sizing: border-box; z-index: 10;
        }
        
        h1 { font-size: 2em; margin-bottom: 20px; font-weight: 800; text-shadow: 2px 2px 0px #ffe6eb; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        .fade-in { animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        @keyframes popIn { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

        .btn { padding: 12px 30px; font-size: 1.2em; border: none; border-radius: 50px; cursor: pointer; margin: 10px; font-family: 'Kanit'; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s; position: relative; }
        .btn-love { background: linear-gradient(45deg, #ff4d79, #ff8fa3); color: white; }
        .btn-love:hover { transform: scale(1.1) translateY(-3px); box-shadow: 0 10px 25px rgba(255, 77, 121, 0.4); }
        .btn-no { background-color: #6c757d; color: white; position: absolute; }

        /* Chat Styles */
        #chat-box { height: 300px; overflow-y: auto; border: 2px solid #ffb3c6; padding: 15px; margin-bottom: 15px; border-radius: 15px; background: #fff; text-align: left; }
        .msg { margin: 5px 0; padding: 10px 15px; border-radius: 20px; display: inline-block; max-width: 80%; font-size: 1em; line-height: 1.4; }
        .msg-user { background: var(--primary); color: white; float: right; clear: both; border-bottom-right-radius: 2px; }
        .msg-bot { background: #f1f3f5; color: #333; float: left; clear: both; border-bottom-left-radius: 2px; }
        .input-group { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 2px solid #ffd1dc; outline: none; font-family: 'Kanit'; }

        /* === 3D World Canvas === */
        #world-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
        }
        
        /* UI ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) */
        #joystick-ui {
            position: fixed; bottom: 20px; right: 20px; z-index: 20;
            display: none; /* ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏ô */
            flex-direction: column; align-items: center; gap: 10px;
        }
        .control-row { display: flex; gap: 10px; }
        .control-btn {
            width: 60px; height: 60px; border-radius: 50%; background: rgba(255, 255, 255, 0.5);
            border: 2px solid white; backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; font-size: 24px; color: var(--primary);
            user-select: none; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
        }
        .control-btn:active { background: rgba(255, 77, 121, 0.8); color: white; }

        #instruction-text {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.5); color: white; padding: 10px 20px; border-radius: 20px;
            z-index: 20; display: none; font-size: 0.9em; pointer-events: none;
        }

        /* Concert & Curtain */
        .curtain-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; display: flex; }
        .curtain-left, .curtain-right { width: 50%; height: 100%; background: #a00020; transition: transform 2.5s cubic-bezier(0.25, 1, 0.5, 1); position: relative; box-shadow: inset -5px 0 10px rgba(0,0,0,0.5); background-image: repeating-linear-gradient(90deg, #a00020 0px, #800010 20px, #a00020 40px); }
        .curtain-open .curtain-left { transform: translateX(-100%); }
        .curtain-open .curtain-right { transform: translateX(100%); }
        .video-frame { border: 8px solid #333; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; aspect-ratio: 16 / 9; background: #000; margin-bottom: 20px; }

        /* Photo Page 3 */
        img.my-photo { width: 200px; height: 200px; object-fit: cover; border-radius: 50%; border: 6px solid white; box-shadow: 0 10px 30px rgba(255, 77, 121, 0.3); margin-bottom: 20px; animation: heartbeat 1.5s infinite; }
        @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.05); } 30% { transform: scale(1); } 45% { transform: scale(1.05); } 60% { transform: scale(1); } }
        
        /* Gift & Voucher */
        .gift-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .gift-box { width: 80px; height: 80px; background: linear-gradient(135deg, #ff4d79, #ff0040); color: white; display: flex; justify-content: center; align-items: center; border-radius: 15px; font-size: 2.5em; cursor: pointer; box-shadow: 0 8px 20px rgba(255, 0, 64, 0.3); transition: all 0.3s; position: relative; }
        .gift-box:hover { transform: scale(1.1) rotate(5deg); }
        .gift-box.shaking { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .voucher-card { background: linear-gradient(135deg, #fff, #fff0f5); border: 3px dashed var(--primary); border-radius: 20px; padding: 20px; margin-top: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }
        .voucher-card::before, .voucher-card::after { content: ''; position: absolute; height: 30px; width: 30px; background-color: var(--bg); border-radius: 50%; top: 50%; transform: translateY(-50%); }
        .voucher-card::before { left: -18px; box-shadow: inset -3px 0 0 var(--primary); }
        .voucher-card::after { right: -18px; box-shadow: inset 3px 0 0 var(--primary); }
        .voucher-title { font-size: 1.5em; font-weight: 800; color: var(--primary); margin: 0; }
        .voucher-prize { font-size: 2em; font-weight: 800; color: #d63384; margin: 15px 0; text-shadow: 1px 1px 0px white; }
        .voucher-details { font-size: 0.9em; color: #888; }
        .btn-share-line { background-color: var(--line-color); color: white; width: 100%; margin: 20px 0 0 0; display: flex; justify-content: center; align-items: center; gap: 10px; text-decoration: none; }
        .btn-share-line:hover { background-color: #05b34c; transform: scale(1.05); }

    </style>
</head>
<body>

    <div id="world-container"></div>
    
    <div id="instruction-text">‡∏Å‡∏î‡∏•‡∏π‡∏Å‡∏®‡∏£ ‚¨ÜÔ∏è ‚¨áÔ∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô | ‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏´‡∏≤‡∏°‡πà‡∏≤‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á! ‚ù§Ô∏è</div>
    <div id="joystick-ui">
        <div class="control-btn" id="btnUp"><i class="fas fa-arrow-up"></i></div>
        <div class="control-row">
            <div class="control-btn" id="btnLeft"><i class="fas fa-arrow-left"></i></div>
            <div class="control-btn" id="btnDown"><i class="fas fa-arrow-down"></i></div>
            <div class="control-btn" id="btnRight"><i class="fas fa-arrow-right"></i></div>
        </div>
    </div>

    <div id="page1" class="container fade-in">
        <h1>‡πÅ‡∏ü‡∏ô‡πÜ ‡∏£‡∏±‡∏Å‡πÄ‡∏Ñ‡πâ‡∏≤‡∏°‡∏±‡πâ‡∏¢? ‚ù§Ô∏è</h1>
        <p style="color: #ff8fa3; margin-bottom: 30px;">(‡∏ï‡∏≠‡∏ö‡∏î‡∏µ‡πÜ ‡∏ô‡∏∞‡∏à‡πä‡∏∞)</p>
        <div style="position: relative; height: 120px;">
            <button class="btn btn-love" onclick="handleLove()">‡∏£‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÇ‡∏•‡∏Å!</button>
            <button class="btn btn-no" id="btnNo" onmouseover="runAway()">‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å</button>
        </div>
    </div>

    <div id="page2" class="container hidden">
        <h2>‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‚ù§Ô∏è</h2>
        <p style="color: #d63384; font-size: 1em; margin: -10px 0 15px 0;">
            ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏∞ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏à‡∏∞‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏û‡∏•‡∏¥‡∏ô üòÜ
        </p>
        <div id="chat-box"></div>
        <div class="input-group">
            <input type="text" id="userMsg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeypress="handleEnter(event)">
            <button class="btn btn-love" style="margin:0; padding: 5px 20px;" onclick="sendMessage()">‡∏™‡πà‡∏á</button>
        </div>
        <p style="font-size: 0.8em; color: #aaa; margin-top: 10px;">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å <span id="chatCount" style="font-weight:bold; color:var(--primary);">5</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
    </div>

    <div id="pageConcert" class="container hidden">
        <div class="curtain-container" id="curtains">
            <div class="curtain-left"></div>
            <div class="curtain-right"></div>
        </div>

        <h2>‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß üé∂</h2>
        <p style="color: #ff8fa3;">‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏∞‡πÄ‡∏≠‡∏á‡∏ô‡∏∞</p>
        <div class="video-frame">
            <iframe id="youtubeVideo" width="100%" height="100%" 
                src="https://www.youtube.com/embed/dQw4w9WgXcQ?enablejsapi=1" 
                title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
            </iframe>
        </div>
        <button class="btn btn-love" onclick="goToLovePage()">‡∏ü‡∏±‡∏á‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ï‡πà‡∏≠ ‚ù§Ô∏è</button>
    </div>

    <div id="page3" class="container hidden">
        <img src="IMG_5906.JPG" alt="My Face" class="my-photo">
        <h1>‡∏£‡∏±‡∏Å‡πÅ‡∏ü‡∏ô‡πÜ ‡∏°‡∏≤‡∏Å‡∏ô‡∏∞!</h1>
        <p style="font-size: 1.2em;">‡πÄ‡∏à‡πâ‡∏≤‡∏ï‡∏î‡πÄ‡∏´‡∏°‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤ üí®‚ù§Ô∏è</p>
        <br>
        <button class="btn btn-love" onclick="goToGifts()">‡πÑ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç üéÅ</button>
    </div>

    <div id="page4" class="container hidden">
        <h1 id="giftTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç 1 ‡∏Å‡∏•‡πà‡∏≠‡∏á! üéÅ</h1>
        <p id="giftSubtitle">‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏Ç‡∏≠‡∏á‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡∏¢</p>
        <div class="gift-container">
            <div class="gift-box" onclick="openGift(this)">?</div>
            <div class="gift-box" onclick="openGift(this)">?</div>
            <div class="gift-box" onclick="openGift(this)">?</div>
        </div>
        <div id="voucherCard" class="voucher-card hidden fade-in">
            <h3 class="voucher-title">üíñ Valentine Voucher üíñ</h3>
            <p style="margin: 10px 0;">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞‡∏™‡∏±‡πà‡∏á...</p>
            <div id="voucherPrizeResult" class="voucher-prize"></div>
            <div class="voucher-details">
                <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞ (‡∏Ñ‡∏ô‡∏™‡∏ß‡∏¢)</p>
                <p>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ‡∏õ‡∏≤‡∏£‡πå‡∏Ñ‡∏Å‡∏µ‡πâ (‡∏Ñ‡∏ô‡∏´‡∏•‡πà‡∏≠)</p>
                <p>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span id="voucherDate"></span> (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!)</p>
            </div>
            <button class="btn btn-share-line" onclick="shareToLine()">
                <i class="fab fa-line" style="font-size: 1.5em;"></i> ‡∏Å‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏£‡πå‡∏Ñ‡∏Å‡∏µ‡πâ‡∏î‡∏π‡πÉ‡∏ô LINE!
            </button>
        </div>
    </div>

    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô Background & Page 1 & Chat (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        function runAway() { const btn = document.getElementById('btnNo'); const container = document.getElementById('page1'); const x = Math.random() * (container.offsetWidth - 100); const y = Math.random() * (container.offsetHeight - 50); const texts = ["‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏≠?", "‡∏°‡∏∑‡∏≠‡∏•‡∏±‡πà‡∏ô‡∏õ‡πà‡∏≤‡∏ß?", "‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏≠‡∏Å", "‡∏£‡∏±‡∏Å‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ñ‡∏≠‡∏∞", "‡∏Æ‡∏±‡πà‡∏ô‡πÅ‡∏ô‡πà!"]; btn.innerText = texts[Math.floor(Math.random() * texts.length)]; btn.style.left = `${x}px`; btn.style.top = `${y}px`; }
        function handleLove() { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); setTimeout(() => { switchPage('page1', 'page2'); }, 1000); }
        function switchPage(fromId, toId) { document.getElementById(fromId).classList.add('hidden'); const toPage = document.getElementById(toId); toPage.classList.remove('hidden'); toPage.classList.add('fade-in'); }

        let chatCount = 5; let chatHistory = [];
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
        async function sendMessage() {
            const input = document.getElementById('userMsg'); const msg = input.value.trim(); if (!msg) return;
            addMessage(msg, 'user'); input.value = ''; const loadingId = addMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå...", 'bot', true);
            try { const res = await fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ message: msg, history: chatHistory }) }); const data = await res.json(); document.getElementById(loadingId).remove(); addMessage(data.reply, 'bot'); chatHistory.push({ role: "user", content: msg }); chatHistory.push({ role: "assistant", content: data.reply }); } catch (err) { document.getElementById(loadingId).remove(); addMessage("‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢... ‡πÅ‡∏ï‡πà‡πÄ‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏Å‡∏ï‡∏∞‡πÄ‡∏≠‡∏á‡∏ô‡∏∞", 'bot'); }
            chatCount--; document.getElementById('chatCount').innerText = chatCount;
            if (chatCount <= 0) { 
                setTimeout(() => { 
                    document.getElementById('page2').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ä‡∏ó
                    start3DWorld(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏î‡∏¥‡∏ô 3D!
                }, 1500); 
            }
        }
        function addMessage(text, sender, isLoading = false) { const chatBox = document.getElementById('chat-box'); const div = document.createElement('div'); div.className = `msg msg-${sender}`; div.innerText = text; if(isLoading) div.id = 'loading-' + Date.now(); chatBox.appendChild(div); const clear = document.createElement('div'); clear.style.clear = 'both'; chatBox.appendChild(clear); chatBox.scrollTop = chatBox.scrollHeight; return div.id; }

        // ==========================================
        // üéÆ 3D WALKING LOGIC (THREE.JS) üéÆ
        // ==========================================
        let scene, camera, renderer, player;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let is3DActive = false;

        function start3DWorld() {
            is3DActive = true;
            document.getElementById('world-container').style.display = 'block';
            document.getElementById('joystick-ui').style.display = 'flex';
            document.getElementById('instruction-text').style.display = 'block';

            // 1. Setup Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xfff0f5); // ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô
            scene.fog = new THREE.Fog(0xfff0f5, 1, 20); // ‡∏´‡∏°‡∏≠‡∏Å‡∏à‡∏≤‡∏á‡πÜ

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 5); // ‡∏™‡∏π‡∏á 1.6 ‡πÄ‡∏°‡∏ï‡∏£ (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≤‡∏¢‡∏ï‡∏≤)

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('world-container').appendChild(renderer.domElement);

            // 2. Add Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            // 3. Add Floor (‡∏û‡∏£‡∏°‡πÅ‡∏î‡∏á)
            const floorGeo = new THREE.PlaneGeometry(10, 50);
            const floorMat = new THREE.MeshBasicMaterial({ color: 0xffb3c6 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // 4. Load Photos & Create Frames
            const textureLoader = new THREE.TextureLoader();
            
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ
            function createFrame(imgPath, x, z, rotationY) {
                textureLoader.load(imgPath, (texture) => {
                    const aspect = texture.image.width / texture.image.height;
                    const geo = new THREE.BoxGeometry(2, 2/aspect, 0.1); // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ
                    const mat = new THREE.MeshBasicMaterial({ map: texture });
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.set(x, 1.6, z);
                    mesh.rotation.y = rotationY;
                    
                    // ‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß
                    const frameGeo = new THREE.BoxGeometry(2.2, (2/aspect)+0.2, 0.05);
                    const frameMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
                    const frame = new THREE.Mesh(frameGeo, frameMat);
                    frame.position.set(0, 0, -0.05);
                    mesh.add(frame);
                    
                    scene.add(mesh);
                });
            }

            // ‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ 4 ‡∏£‡∏π‡∏õ (‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô)
            createFrame('photo1.jpg', -2.5, 2, 0.5);  // ‡∏ã‡πâ‡∏≤‡∏¢
            createFrame('photo2.jpg', 2.5, 0, -0.5);  // ‡∏Ç‡∏ß‡∏≤
            createFrame('photo3.jpg', -2.5, -3, 0.5); // ‡∏ã‡πâ‡∏≤‡∏¢
            createFrame('photo4.jpg', 2.5, -6, -0.5); // ‡∏Ç‡∏ß‡∏≤

            // 5. Create "The End" Curtain (‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢)
            const endGeo = new THREE.BoxGeometry(8, 5, 0.1);
            const endMat = new THREE.MeshBasicMaterial({ color: 0xa00020 }); // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
            const endWall = new THREE.Mesh(endGeo, endMat);
            endWall.position.set(0, 2.5, -10); // ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏≤‡∏á
            scene.add(endWall);

            // Text ‡∏ö‡∏ô‡∏°‡πà‡∏≤‡∏ô
            // (Three.js ‡∏™‡∏£‡πâ‡∏≤‡∏á text ‡∏¢‡∏≤‡∏Å ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÉ‡∏ä‡πâ logic ‡∏ä‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÅ‡∏ó‡∏ô)

            // 6. Controls
            document.addEventListener('keydown', (e) => {
                switch(e.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = true; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = true; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
                    case 'ArrowRight': case 'KeyD': moveRight = true; break;
                }
            });
            document.addEventListener('keyup', (e) => {
                switch(e.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = false; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = false; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
                    case 'ArrowRight': case 'KeyD': moveRight = false; break;
                }
            });

            // Mobile Touch Controls
            const btnUp = document.getElementById('btnUp');
            const btnDown = document.getElementById('btnDown');
            const btnLeft = document.getElementById('btnLeft');
            const btnRight = document.getElementById('btnRight');

            const handleTouch = (btn, dir, val) => {
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); dir = true; });
                btn.addEventListener('touchend', (e) => { e.preventDefault(); dir = false; });
                // Hacky assignment because primitives are passed by value
                if(btn.id === 'btnUp') { btn.addEventListener('touchstart', ()=>moveForward=true); btn.addEventListener('touchend', ()=>moveForward=false); }
                if(btn.id === 'btnDown') { btn.addEventListener('touchstart', ()=>moveBackward=true); btn.addEventListener('touchend', ()=>moveBackward=false); }
                if(btn.id === 'btnLeft') { btn.addEventListener('touchstart', ()=>moveLeft=true); btn.addEventListener('touchend', ()=>moveLeft=false); }
                if(btn.id === 'btnRight') { btn.addEventListener('touchstart', ()=>moveRight=true); btn.addEventListener('touchend', ()=>moveRight=false); }
            };
            handleTouch(btnUp); handleTouch(btnDown); handleTouch(btnLeft); handleTouch(btnRight);

            animate3D();
        }

        function animate3D() {
            if (!is3DActive) return;
            requestAnimationFrame(animate3D);

            // Movement Logic
            const speed = 0.1;
            const rotSpeed = 0.03;

            if (moveForward) camera.translateZ(-speed);
            if (moveBackward) camera.translateZ(speed);
            if (moveLeft) camera.rotateY(rotSpeed);
            if (moveRight) camera.rotateY(-rotSpeed);
            
            // Lock Height (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏¥‡∏ô)
            camera.position.y = 1.6;

            // Check Win Condition (‡πÄ‡∏î‡∏¥‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢ Z < -8)
            if (camera.position.z < -8) {
                is3DActive = false;
                document.getElementById('world-container').style.display = 'none'; // ‡∏õ‡∏¥‡∏î 3D
                document.getElementById('joystick-ui').style.display = 'none';
                document.getElementById('instruction-text').style.display = 'none';
                
                // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Concert
                const concertPage = document.getElementById('pageConcert');
                concertPage.classList.remove('hidden');
                concertPage.classList.add('fade-in');
                
                // ‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡πà‡∏≤‡∏ô
                setTimeout(() => { document.getElementById('curtains').classList.add('curtain-open'); }, 500);
            }

            renderer.render(scene, camera);
        }

        // Window Resize Handle
        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // --- Functions Page 3 & 4 (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        function goToLovePage() { switchPage('pageConcert', 'page3'); }
        function goToGifts() { switchPage('page3', 'page4'); }
        let finalPrize = ""; 
        function openGift(element) { if(finalPrize !== "") return; element.classList.add('shaking'); setTimeout(() => { element.classList.remove('shaking'); const prizes = ['‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞ üê∑', '‡∏ä‡∏≤‡∏ö‡∏π üç≤', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô üç£', 'MK ‡∏™‡∏∏‡∏Å‡∏µ‡πâ üç≤', 'BBQ Plaza üê≤']; finalPrize = prizes[Math.floor(Math.random() * prizes.length)]; document.querySelector('.gift-container').style.display = 'none'; document.getElementById('giftSubtitle').style.display = 'none'; document.getElementById('giftTitle').innerText = "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö..."; const today = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }); document.getElementById('voucherPrizeResult').innerText = finalPrize; document.getElementById('voucherDate').innerText = today; document.getElementById('voucherCard').classList.remove('hidden'); confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); }, 800); }
        function shareToLine() { const shareText = `üíñ Voucher Alert! üíñ\n\n‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏Å‡∏¥‡∏ô "${finalPrize}"\n\n‡∏õ‡∏≤‡∏£‡πå‡∏Ñ‡∏Å‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏Å‡∏¥‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß!\n\n(‡∏à‡∏≤‡∏Å Valentines App)`; const encodedText = encodeURIComponent(shareText); const lineUrl = `https://line.me/R/msg/text/?${encodedText}`; window.open(lineUrl, '_blank'); }
    </script>
</body>
</html>