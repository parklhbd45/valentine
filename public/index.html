<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Booting V.A.L.E.N.T.I.N.E. OS...</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #ff4d79; --secondary: #ffb3c6; --bg: #fff0f5; --line-color: #06C755;
            --neon-pink: #ff80ab; --dark-bg: #2a0a16;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg);
            text-align: center; margin: 0; height: 100vh; overflow: hidden;
            color: #d63384; user-select: none;
        }

        /* === BOOT SCREEN (Sumikko Gurashi) === */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #FFE8F5 0%, #FFF0F5 40%, #FFF5F9 100%);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden; transition: opacity 1.5s ease-in-out;
        }
        /* Background floating hearts */
        .boot-hearts { position: absolute; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 0; }
        .boot-heart-float {
            position: absolute; bottom: -40px; opacity: 0;
            animation: bootHeartRise 9s linear infinite;
        }
        @keyframes bootHeartRise {
            0% { opacity: 0; transform: translateY(0) rotate(0deg) scale(0.8); }
            10% { opacity: 0.5; }
            90% { opacity: 0.5; }
            100% { opacity: 0; transform: translateY(-110vh) rotate(360deg) scale(1.2); }
        }
        /* Ground / floor */
        .sumikko-ground {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
            background: linear-gradient(180deg, #FFDDE8 0%, #FFD0DF 100%);
            border-radius: 50% 50% 0 0 / 30px 30px 0 0;
        }
        .sumikko-ground::before {
            content: ''; position: absolute; top: -5px; left: 0; width: 100%; height: 10px;
            background: repeating-linear-gradient(90deg, transparent, transparent 30px, rgba(255,255,255,0.3) 30px, rgba(255,255,255,0.3) 32px);
        }
        /* Stage */
        .sumikko-stage {
            position: relative; width: 90%; max-width: 420px; height: 300px; z-index: 1;
        }

        /* === Shirokuma (White Bear - Parkky) === */
        .shirokuma-wrapper {
            position: absolute; bottom: 30px; left: 0;
            transition: transform 3.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .shirokuma-wrapper.walking .shirokuma-body { animation: bobWalk 0.4s ease-in-out infinite; }
        .shirokuma-wrapper.kissing { transition: transform 0.4s ease-out; }
        .shirokuma-char { position: relative; width: 110px; height: 140px; }
        .shirokuma-body {
            position: absolute; bottom: 22px; left: 5px;
            width: 100px; height: 105px;
            background: radial-gradient(ellipse at 40% 30%, #FFFFFF 0%, #FFF8F0 60%, #F5EDE3 100%);
            border-radius: 50% 50% 46% 46%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06), inset 0 -3px 8px rgba(0,0,0,0.03);
        }
        .shirokuma-ear {
            width: 28px; height: 26px;
            background: radial-gradient(circle at 50% 50%, #FFFFFF, #FFF8F0);
            border-radius: 50%;
            position: absolute; top: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }
        .shirokuma-ear.left { left: 12px; }
        .shirokuma-ear.right { right: 12px; }
        .shirokuma-ear-inner {
            width: 14px; height: 12px; background: #FFD4CC; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .shirokuma-eye {
            width: 6px; height: 7px; background: #2D2D2D; border-radius: 50%;
            position: absolute; top: 55px;
        }
        .shirokuma-eye.left { left: 32px; }
        .shirokuma-eye.right { right: 32px; }
        .shirokuma-nose {
            width: 0; height: 0;
            border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-top: 6px solid #C4A882;
            position: absolute; top: 68px; left: 50%; transform: translateX(-50%);
        }
        .shirokuma-blush {
            width: 18px; height: 10px; background: rgba(255,150,150,0.35); border-radius: 50%;
            position: absolute; top: 66px;
        }
        .shirokuma-blush.left { left: 12px; }
        .shirokuma-blush.right { right: 12px; }
        .shirokuma-arm {
            width: 22px; height: 16px;
            background: radial-gradient(circle, #FFFFFF, #FFF8F0);
            border-radius: 50%; position: absolute; bottom: 40px;
        }
        .shirokuma-arm.left { left: 0; transform: rotate(15deg); }
        .shirokuma-arm.right { right: 0; transform: rotate(-15deg); }
        .char-name {
            text-align: center; font-family: 'Kanit', sans-serif; font-size: 12px;
            color: #d63384; font-weight: 600; position: absolute; bottom: 2px; width: 100%;
        }

        /* === Pengin? (Oke) === */
        .pengin-wrapper { position: absolute; bottom: 30px; right: 10%; }
        .pengin-char { position: relative; width: 95px; height: 130px; }
        .pengin-body {
            position: absolute; bottom: 22px; left: 5px;
            width: 85px; height: 95px;
            background: radial-gradient(ellipse at 40% 30%, #D5F0DC 0%, #C8E6D0 60%, #B8DBBE 100%);
            border-radius: 48% 48% 44% 44%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06), inset 0 -3px 8px rgba(0,0,0,0.03);
        }
        .pengin-eye {
            width: 6px; height: 7px; background: #2D2D2D; border-radius: 50%;
            position: absolute; top: 42px;
        }
        .pengin-eye.left { left: 23px; }
        .pengin-eye.right { right: 23px; }
        .pengin-beak {
            width: 0; height: 0;
            border-left: 6px solid transparent; border-right: 6px solid transparent;
            border-top: 8px solid #F5C542;
            position: absolute; top: 55px; left: 50%; transform: translateX(-50%);
        }
        .pengin-blush {
            width: 16px; height: 9px; background: rgba(255,150,150,0.35); border-radius: 50%;
            position: absolute; top: 53px;
        }
        .pengin-blush.left { left: 6px; }
        .pengin-blush.right { right: 6px; }
        .pengin-arm {
            width: 18px; height: 14px;
            background: radial-gradient(circle, #D5F0DC, #C8E6D0);
            border-radius: 50%; position: absolute; bottom: 35px;
        }
        .pengin-arm.left { left: 0; transform: rotate(15deg); }
        .pengin-arm.right { right: 0; transform: rotate(-15deg); }

        /* Kiss effects */
        .kiss-hearts-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .kiss-heart-pop {
            position: absolute; font-size: 24px; opacity: 0; pointer-events: none;
        }
        .kiss-heart-pop.active {
            animation: kissHeartFloat 2s ease-out forwards;
        }
        @keyframes kissHeartFloat {
            0% { opacity: 0; transform: scale(0) translateY(0); }
            25% { opacity: 1; transform: scale(1.3) translateY(-20px); }
            100% { opacity: 0; transform: scale(0.6) translateY(-100px); }
        }
        /* Valentine message */
        .valentine-text { text-align: center; margin-top: 5px; position: relative; z-index: 2; }
        .valentine-msg {
            font-family: 'Kanit', sans-serif; font-size: 1.8em; font-weight: 800;
            color: #d63384; opacity: 0; text-shadow: 2px 2px 0px #ffe6eb;
        }
        .valentine-sub {
            font-family: 'Kanit', sans-serif; font-size: 1em; color: #ff8fa3; opacity: 0; margin-top: 2px;
        }
        .valentine-msg.show { animation: fadeSlideUp 0.8s ease-out forwards; }
        .valentine-sub.show { animation: fadeSlideUp 0.8s ease-out 0.3s forwards; }

        @keyframes bobWalk { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes fadeSlideUp { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }

        /* === CONTAINER === */
        .container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; background: rgba(255, 255, 255, 0.95); padding: 30px;
            border-radius: 30px; box-shadow: 0 20px 60px rgba(255, 77, 121, 0.3);
            transition: opacity 0.5s; backdrop-filter: blur(10px);
            border: 3px solid white; box-sizing: border-box; z-index: 10;
            display: none;
        }
        .container.active { display: block; }

        h1 { font-size: 2em; margin-bottom: 20px; font-weight: 800; text-shadow: 2px 2px 0px #ffe6eb; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        .fade-in { animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        @keyframes popIn { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

        .btn { padding: 12px 30px; font-size: 1.2em; border: none; border-radius: 50px; cursor: pointer; margin: 10px; font-family: 'Kanit'; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s; position: relative; }
        .btn-love { background: linear-gradient(45deg, #ff4d79, #ff8fa3); color: white; }
        .btn-love:hover { transform: scale(1.1) translateY(-3px); box-shadow: 0 10px 25px rgba(255, 77, 121, 0.4); }
        .btn-no { background-color: #6c757d; color: white; position: absolute; }

        #chat-box { height: 300px; overflow-y: auto; border: 2px solid #ffb3c6; padding: 15px; margin-bottom: 15px; border-radius: 15px; background: #fff; text-align: left; }
        .msg { margin: 5px 0; padding: 10px 15px; border-radius: 20px; display: inline-block; max-width: 80%; font-size: 1em; line-height: 1.4; }
        .msg-user { background: var(--primary); color: white; float: right; clear: both; border-bottom-right-radius: 2px; }
        .msg-bot { background: #f1f3f5; color: #333; float: left; clear: both; border-bottom-left-radius: 2px; }
        .input-group { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 2px solid #ffd1dc; outline: none; font-family: 'Kanit'; }

        #world-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; display: none; }
        #joystick-ui { position: fixed; bottom: 20px; right: 20px; z-index: 20; display: none; flex-direction: column; align-items: center; gap: 10px; }
        .control-row { display: flex; gap: 10px; }
        .control-btn { width: 60px; height: 60px; border-radius: 50%; background: rgba(255, 255, 255, 0.5); border: 2px solid white; backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; font-size: 24px; color: var(--primary); user-select: none; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .control-btn:active { background: rgba(255, 77, 121, 0.8); color: white; }
        #instruction-text { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); color: white; padding: 10px 20px; border-radius: 20px; z-index: 20; display: none; font-size: 0.9em; pointer-events: none; }

        .curtain-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; display: flex; }
        .curtain-left, .curtain-right { width: 50%; height: 100%; background: #a00020; transition: transform 2.5s cubic-bezier(0.25, 1, 0.5, 1); position: relative; box-shadow: inset -5px 0 10px rgba(0,0,0,0.5); background-image: repeating-linear-gradient(90deg, #a00020 0px, #800010 20px, #a00020 40px); }
        .curtain-open .curtain-left { transform: translateX(-100%); }
        .curtain-open .curtain-right { transform: translateX(100%); }
        .video-frame { border: 8px solid #333; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; aspect-ratio: 16 / 9; background: #000; margin-bottom: 20px; }

        img.my-photo { width: 200px; height: 200px; object-fit: cover; border-radius: 50%; border: 6px solid white; box-shadow: 0 10px 30px rgba(255, 77, 121, 0.3); margin-bottom: 20px; animation: heartbeat 1.5s infinite; }
        @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.05); } 30% { transform: scale(1); } 45% { transform: scale(1.05); } 60% { transform: scale(1); } }

        .gift-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .gift-box { width: 80px; height: 80px; background: linear-gradient(135deg, #ff4d79, #ff0040); color: white; display: flex; justify-content: center; align-items: center; border-radius: 15px; font-size: 2.5em; cursor: pointer; box-shadow: 0 8px 20px rgba(255, 0, 64, 0.3); transition: all 0.3s; position: relative; }
        .gift-box:hover { transform: scale(1.1) rotate(5deg); }
        .gift-box.shaking { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .voucher-card { background: linear-gradient(135deg, #fff, #fff0f5); border: 3px dashed var(--primary); border-radius: 20px; padding: 20px; margin-top: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }
        .voucher-card::before, .voucher-card::after { content: ''; position: absolute; height: 30px; width: 30px; background-color: var(--bg); border-radius: 50%; top: 50%; transform: translateY(-50%); }
        .voucher-card::before { left: -18px; box-shadow: inset -3px 0 0 var(--primary); }
        .voucher-card::after { right: -18px; box-shadow: inset 3px 0 0 var(--primary); }
        .voucher-title { font-size: 1.5em; font-weight: 800; color: var(--primary); margin: 0; }
        .voucher-prize { font-size: 2em; font-weight: 800; color: #d63384; margin: 15px 0; text-shadow: 1px 1px 0px white; }
        .voucher-details { font-size: 0.9em; color: #888; }
        .btn-share-line { background-color: var(--line-color); color: white; width: 100%; margin: 20px 0 0 0; display: flex; justify-content: center; align-items: center; gap: 10px; text-decoration: none; }
        .btn-share-line:hover { background-color: #05b34c; transform: scale(1.05); }

        .heart-bg { position: absolute; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none; display: none; }
        .heart-bg.active { display: block; }
        .heart-particle { position: absolute; bottom: -20px; color: rgba(255, 77, 121, 0.3); animation: floatUp 10s linear infinite; font-size: 20px; }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; } }
    </style>
</head>
<body>

    <!-- === BOOT SCREEN: Sumikko Gurashi Animation === -->
    <div id="boot-screen">
        <div class="boot-hearts" id="bootHearts"></div>
        <div class="sumikko-ground"></div>

        <div class="sumikko-stage" id="sumikkoStage">
            <!-- Shirokuma (Parkky) -->
            <div class="shirokuma-wrapper" id="shirokuma">
                <div class="shirokuma-char">
                    <div class="shirokuma-ear left"><div class="shirokuma-ear-inner"></div></div>
                    <div class="shirokuma-ear right"><div class="shirokuma-ear-inner"></div></div>
                    <div class="shirokuma-body">
                        <div class="shirokuma-eye left"></div>
                        <div class="shirokuma-eye right"></div>
                        <div class="shirokuma-nose"></div>
                        <div class="shirokuma-blush left"></div>
                        <div class="shirokuma-blush right"></div>
                    </div>
                    <div class="shirokuma-arm left"></div>
                    <div class="shirokuma-arm right"></div>
                    <div class="char-name">Parkky</div>
                </div>
            </div>

            <!-- Pengin? (Oke) -->
            <div class="pengin-wrapper" id="pengin">
                <div class="pengin-char">
                    <div class="pengin-body">
                        <div class="pengin-eye left"></div>
                        <div class="pengin-eye right"></div>
                        <div class="pengin-beak"></div>
                        <div class="pengin-blush left"></div>
                        <div class="pengin-blush right"></div>
                    </div>
                    <div class="pengin-arm left"></div>
                    <div class="pengin-arm right"></div>
                    <div class="char-name">Oke</div>
                </div>
            </div>

            <!-- Kiss hearts overlay -->
            <div class="kiss-hearts-container" id="kissHearts"></div>
        </div>

        <div class="valentine-text">
            <div class="valentine-msg" id="vMsg">Happy Valentine's Day</div>
            <div class="valentine-sub" id="vSub">Parkky & Oke</div>
        </div>
    </div>

    <div class="heart-bg" id="heartBg"></div>
    <div id="world-container"></div>

    <div id="instruction-text">‡∏Å‡∏î‡∏•‡∏π‡∏Å‡∏®‡∏£ ‚¨ÜÔ∏è ‚¨áÔ∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô | ‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏´‡∏≤‡∏°‡πà‡∏≤‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á! ‚ù§Ô∏è</div>
    <div id="joystick-ui">
        <div class="control-btn" id="btnUp"><i class="fas fa-arrow-up"></i></div>
        <div class="control-row">
            <div class="control-btn" id="btnLeft"><i class="fas fa-arrow-left"></i></div>
            <div class="control-btn" id="btnDown"><i class="fas fa-arrow-down"></i></div>
            <div class="control-btn" id="btnRight"><i class="fas fa-arrow-right"></i></div>
        </div>
    </div>

    <div id="page1" class="container fade-in">
        <h1>‡πÅ‡∏ü‡∏ô‡πÜ ‡∏£‡∏±‡∏Å‡πÄ‡∏Ñ‡πâ‡∏≤‡∏°‡∏±‡πâ‡∏¢? ‚ù§Ô∏è</h1>
        <p style="color: #ff8fa3; margin-bottom: 30px;">(‡∏ï‡∏≠‡∏ö‡∏î‡∏µ‡πÜ ‡∏ô‡∏∞‡∏à‡πä‡∏∞)</p>
        <div style="position: relative; height: 120px;">
            <button class="btn btn-love" onclick="handleLove()">‡∏£‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÇ‡∏•‡∏Å!</button>
            <button class="btn btn-no" id="btnNo" onmouseover="runAway()">‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å</button>
        </div>
    </div>

    <div id="page2" class="container hidden">
        <h2>‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‚ù§Ô∏è</h2>
        <p style="color: #d63384; font-size: 1em; margin: -10px 0 15px 0;">
            ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏∞ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏à‡∏∞‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏û‡∏•‡∏¥‡∏ô üòÜ
        </p>
        <div id="chat-box"></div>
        <div class="input-group">
            <input type="text" id="userMsg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeypress="handleEnter(event)">
            <button class="btn btn-love" style="margin:0; padding: 5px 20px;" onclick="sendMessage()">‡∏™‡πà‡∏á</button>
        </div>
        <p style="font-size: 0.8em; color: #aaa; margin-top: 10px;">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å <span id="chatCount" style="font-weight:bold; color:var(--primary);">5</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
    </div>

    <div id="pageConcert" class="container hidden">
        <div class="curtain-container" id="curtains">
            <div class="curtain-left"></div>
            <div class="curtain-right"></div>
        </div>
        <h2>‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß üé∂</h2>
        <p style="color: #ff8fa3;">‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏∞‡πÄ‡∏≠‡∏á‡∏ô‡∏∞</p>
        <div class="video-frame">
            <iframe id="youtubeVideo" width="100%" height="100%"
                src="https://www.youtube.com/embed/TqN5YKD3dgw?enablejsapi=1"
                title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
            </iframe>
        </div>
        <button class="btn btn-love" onclick="goToLovePage()">‡∏ü‡∏±‡∏á‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ï‡πà‡∏≠ ‚ù§Ô∏è</button>
    </div>

    <div id="page3" class="container hidden">
        <img src="IMG_5906.JPG" alt="My Face" class="my-photo">
        <h1>‡∏£‡∏±‡∏Å‡πÅ‡∏ü‡∏ô‡πÜ ‡∏°‡∏≤‡∏Å‡∏ô‡∏∞!</h1>
        <p style="font-size: 1.2em;">‡πÄ‡∏à‡πâ‡∏≤‡∏ï‡∏î‡πÄ‡∏´‡∏°‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤ üí®‚ù§Ô∏è</p>
        <br>
        <button class="btn btn-love" onclick="goToGifts()">‡πÑ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç üéÅ</button>
    </div>

    <div id="page4" class="container hidden">
        <h1 id="giftTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç 1 ‡∏Å‡∏•‡πà‡∏≠‡∏á! üéÅ</h1>
        <p id="giftSubtitle">‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏Ç‡∏≠‡∏á‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡∏¢</p>
        <div class="gift-container">
            <div class="gift-box" onclick="openGift(this)">?</div>
            <div class="gift-box" onclick="openGift(this)">?</div>
            <div class="gift-box" onclick="openGift(this)">?</div>
        </div>
        <div id="voucherCard" class="voucher-card hidden fade-in">
            <h3 class="voucher-title">üíñ Valentine Voucher üíñ</h3>
            <p style="margin: 10px 0;">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞‡∏™‡∏±‡πà‡∏á...</p>
            <div id="voucherPrizeResult" class="voucher-prize"></div>
            <div class="voucher-details">
                <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞ (‡∏Ñ‡∏ô‡∏™‡∏ß‡∏¢)</p>
                <p>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ‡∏õ‡∏≤‡∏£‡πå‡∏Ñ‡∏Å‡∏µ‡πâ (‡∏Ñ‡∏ô‡∏´‡∏•‡πà‡∏≠)</p>
                <p>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span id="voucherDate"></span> (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!)</p>
            </div>
            <button class="btn btn-share-line" onclick="shareToLine()">
                <i class="fab fa-line" style="font-size: 1.5em;"></i> ‡∏Å‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏£‡πå‡∏Ñ‡∏Å‡∏µ‡πâ‡∏î‡∏π‡πÉ‡∏ô LINE!
            </button>
        </div>
    </div>

    <script>
        // === BOOT SCREEN: Sumikko Gurashi Animation ===

        // Create floating hearts background
        (function createBootHearts() {
            const container = document.getElementById('bootHearts');
            const hearts = ['‚ù§Ô∏è', 'üíï', 'üíñ', 'ü©∑', 'ü§ç'];
            for (let i = 0; i < 20; i++) {
                const h = document.createElement('span');
                h.className = 'boot-heart-float';
                h.innerText = hearts[Math.floor(Math.random() * hearts.length)];
                h.style.left = Math.random() * 100 + '%';
                h.style.fontSize = (Math.random() * 16 + 12) + 'px';
                h.style.animationDuration = (Math.random() * 5 + 6) + 's';
                h.style.animationDelay = (Math.random() * 6) + 's';
                container.appendChild(h);
            }
        })();

        // Sumikko kiss animation
        function startSumikkoAnimation() {
            const shirokuma = document.getElementById('shirokuma');
            const pengin = document.getElementById('pengin');
            const stage = document.getElementById('sumikkoStage');

            // Start walking after 1s
            setTimeout(() => {
                shirokuma.classList.add('walking');

                // Calculate walk distance
                const penginRect = pengin.getBoundingClientRect();
                const shiroRect = shirokuma.getBoundingClientRect();
                const distance = penginRect.left - shiroRect.left - shiroRect.width + 25;

                shirokuma.style.transform = 'translateX(' + distance + 'px)';

                // After walking (3.5s), trigger kiss
                setTimeout(() => {
                    shirokuma.classList.remove('walking');
                    shirokuma.classList.add('kissing');
                    shirokuma.style.transform = 'translateX(' + (distance + 8) + 'px) rotate(6deg)';

                    // Spawn kiss hearts
                    spawnKissHearts();
                    confetti({ particleCount: 120, spread: 70, origin: { y: 0.5 } });

                    // Show valentine message
                    setTimeout(() => {
                        document.getElementById('vMsg').classList.add('show');
                        document.getElementById('vSub').classList.add('show');
                    }, 600);

                    // Transition to page1
                    setTimeout(() => {
                        finishBoot();
                    }, 3000);
                }, 3500);
            }, 1200);
        }

        function spawnKissHearts() {
            const container = document.getElementById('kissHearts');
            const hearts = ['üíñ', 'üíï', '‚ù§Ô∏è', 'üíó', 'üíò'];
            const shirokuma = document.getElementById('shirokuma');
            const rect = shirokuma.getBoundingClientRect();
            const stageRect = document.getElementById('sumikkoStage').getBoundingClientRect();

            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const h = document.createElement('div');
                    h.className = 'kiss-heart-pop';
                    h.innerText = hearts[Math.floor(Math.random() * hearts.length)];
                    h.style.left = (rect.right - stageRect.left - 30 + Math.random() * 40) + 'px';
                    h.style.top = (rect.top - stageRect.top + Math.random() * 30) + 'px';
                    h.style.fontSize = (20 + Math.random() * 16) + 'px';
                    container.appendChild(h);
                    requestAnimationFrame(() => h.classList.add('active'));
                    setTimeout(() => h.remove(), 2200);
                }, i * 250);
            }
        }

        function finishBoot() {
            const bootScreen = document.getElementById('boot-screen');
            bootScreen.style.opacity = '0';
            setTimeout(() => {
                bootScreen.style.display = 'none';
                document.getElementById('page1').classList.add('active');
                document.getElementById('heartBg').classList.add('active');
            }, 1500);
        }

        window.onload = () => { setTimeout(startSumikkoAnimation, 600); };

        // === NAVIGATION LOGIC ===
        function switchPage(fromId, toId) {
            const fromPage = document.getElementById(fromId);
            fromPage.classList.remove('active');
            fromPage.classList.add('hidden');
            const toPage = document.getElementById(toId);
            toPage.classList.remove('hidden');
            toPage.classList.add('active');
            toPage.classList.add('fade-in');
        }

        function createHearts() { const bg = document.getElementById('heartBg'); const symbols = ['‚ù§Ô∏è', 'üíñ', 'üíï', 'ü•∞', 'üåπ']; for(let i=0; i<30; i++) { const heart = document.createElement('div'); heart.className = 'heart-particle'; heart.innerText = symbols[Math.floor(Math.random() * symbols.length)]; heart.style.left = Math.random() * 100 + '%'; heart.style.animationDuration = (Math.random() * 5 + 5) + 's'; heart.style.animationDelay = Math.random() * 5 + 's'; bg.appendChild(heart); } }
        createHearts();
        function runAway() { const btn = document.getElementById('btnNo'); const container = document.getElementById('page1'); const x = Math.random() * (container.offsetWidth - 100); const y = Math.random() * (container.offsetHeight - 50); const texts = ["‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏≠?", "‡∏°‡∏∑‡∏≠‡∏•‡∏±‡πà‡∏ô‡∏õ‡πà‡∏≤‡∏ß?", "‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏≠‡∏Å", "‡∏£‡∏±‡∏Å‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ñ‡∏≠‡∏∞", "‡∏Æ‡∏±‡πà‡∏ô‡πÅ‡∏ô‡πà!"]; btn.innerText = texts[Math.floor(Math.random() * texts.length)]; btn.style.left = `${x}px`; btn.style.top = `${y}px`; }

        function handleLove() {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            setTimeout(() => { switchPage('page1', 'page2'); }, 1000);
        }

        let chatCount = 5; let chatHistory = [];
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
        async function sendMessage() {
            const input = document.getElementById('userMsg'); const msg = input.value.trim(); if (!msg) return;
            addMessage(msg, 'user'); input.value = ''; const loadingId = addMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå...", 'bot', true);
            try { const res = await fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ message: msg, history: chatHistory }) }); const data = await res.json(); document.getElementById(loadingId).remove(); addMessage(data.reply, 'bot'); chatHistory.push({ role: "user", content: msg }); chatHistory.push({ role: "assistant", content: data.reply }); } catch (err) { document.getElementById(loadingId).remove(); addMessage("‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢... ‡πÅ‡∏ï‡πà‡πÄ‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏Å‡∏ï‡∏∞‡πÄ‡∏≠‡∏á‡∏ô‡∏∞", 'bot'); }
            chatCount--; document.getElementById('chatCount').innerText = chatCount;
            if (chatCount <= 0) {
                setTimeout(() => {
                    document.getElementById('page2').classList.remove('active');
                    document.getElementById('page2').classList.add('hidden');
                    start3DWorld();
                }, 1500);
            }
        }
        function addMessage(text, sender, isLoading = false) { const chatBox = document.getElementById('chat-box'); const div = document.createElement('div'); div.className = `msg msg-${sender}`; div.innerText = text; if(isLoading) div.id = 'loading-' + Date.now(); chatBox.appendChild(div); const clear = document.createElement('div'); clear.style.clear = 'both'; chatBox.appendChild(clear); chatBox.scrollTop = chatBox.scrollHeight; return div.id; }

        // === 3D WORLD ===
        let scene, camera, renderer;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let is3DActive = false;
        let walkingTime = 0; const bobSpeed = 8; const bobAmount = 0.05; const baseHeight = 1.6;
        // Effect variables
        let heartParticles, heartVelocities = [];
        let sparkleMat, sparkleParticles;
        let petals3D = [];
        let pinkLight, purpleLight, warmLight;
        let effectTime = 0;

        function start3DWorld() {
            is3DActive = true;
            document.getElementById('world-container').style.display = 'block';
            document.getElementById('joystick-ui').style.display = 'flex';
            document.getElementById('instruction-text').style.display = 'block';

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xfff0f5);
            scene.fog = new THREE.FogExp2(0xfff0f5, 0.06);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, baseHeight, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('world-container').appendChild(renderer.domElement);

            // --- Lighting ---
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            pinkLight = new THREE.PointLight(0xff4d79, 0.8, 18);
            pinkLight.position.set(-3, 3.5, 2);
            scene.add(pinkLight);

            purpleLight = new THREE.PointLight(0xb388ff, 0.6, 18);
            purpleLight.position.set(3, 3, -4);
            scene.add(purpleLight);

            warmLight = new THREE.PointLight(0xffd1dc, 0.5, 25);
            warmLight.position.set(0, 4, -8);
            scene.add(warmLight);

            // --- Floor ---
            const floorGeo = new THREE.PlaneGeometry(12, 50);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0xffb3c6, roughness: 0.8 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // --- Walls (subtle) ---
            const wallMat = new THREE.MeshStandardMaterial({ color: 0xffe8f0, roughness: 0.9, transparent: true, opacity: 0.3 });
            const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(50, 6), wallMat);
            leftWall.position.set(-5, 3, -10); leftWall.rotation.y = Math.PI / 2;
            scene.add(leftWall);
            const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(50, 6), wallMat);
            rightWall.position.set(5, 3, -10); rightWall.rotation.y = -Math.PI / 2;
            scene.add(rightWall);

            // --- Photo frames with glow ---
            const textureLoader = new THREE.TextureLoader();
            function createFrame(imgPath, x, z, rotationY) {
                textureLoader.load(imgPath, (texture) => {
                    const aspect = texture.image.width / texture.image.height;
                    const geo = new THREE.BoxGeometry(2, 2/aspect, 0.1);
                    const mat = new THREE.MeshStandardMaterial({ map: texture, roughness: 0.3 });
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.set(x, 1.6, z);
                    mesh.rotation.y = rotationY;

                    // White frame border
                    const frameGeo = new THREE.BoxGeometry(2.2, (2/aspect)+0.2, 0.05);
                    const frameMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.3 });
                    const frame = new THREE.Mesh(frameGeo, frameMat);
                    frame.position.set(0, 0, -0.06);
                    mesh.add(frame);

                    // Glow behind frame
                    const glowGeo = new THREE.PlaneGeometry(2.8, (2/aspect)+0.8);
                    const glowMat = new THREE.MeshBasicMaterial({
                        color: 0xff4d79, transparent: true, opacity: 0.12, side: THREE.DoubleSide
                    });
                    const glow = new THREE.Mesh(glowGeo, glowMat);
                    glow.position.set(0, 0, -0.1);
                    mesh.add(glow);

                    // Sparkle point light near frame
                    const frameLight = new THREE.PointLight(0xffb3c6, 0.4, 5);
                    frameLight.position.set(0, 0, 0.5);
                    mesh.add(frameLight);

                    scene.add(mesh);
                });
            }
            createFrame('photo1.jpg', -2.5, 2, 0.5);
            createFrame('photo2.jpg', 2.5, 0, -0.5);
            createFrame('photo3.jpg', -2.5, -3, 0.5);
            createFrame('photo4.jpg', 2.5, -6, -0.5);

            // --- End wall (curtain) ---
            const endGeo = new THREE.BoxGeometry(8, 5, 0.1);
            const endMat = new THREE.MeshStandardMaterial({ color: 0xa00020 });
            const endWall = new THREE.Mesh(endGeo, endMat);
            endWall.position.set(0, 2.5, -10);
            scene.add(endWall);

            // === EFFECTS ===

            // --- Heart particles ---
            const heartCount = 40;
            const heartGeo = new THREE.BufferGeometry();
            const heartPositions = new Float32Array(heartCount * 3);
            heartVelocities = [];
            for (let i = 0; i < heartCount; i++) {
                heartPositions[i * 3] = (Math.random() - 0.5) * 10;
                heartPositions[i * 3 + 1] = Math.random() * 5;
                heartPositions[i * 3 + 2] = (Math.random() - 0.5) * 20 - 2;
                heartVelocities.push({
                    x: (Math.random() - 0.5) * 0.008,
                    y: Math.random() * 0.008 + 0.004,
                    z: (Math.random() - 0.5) * 0.005
                });
            }
            heartGeo.setAttribute('position', new THREE.BufferAttribute(heartPositions, 3));

            // Heart texture via canvas
            const hCanvas = document.createElement('canvas');
            hCanvas.width = 64; hCanvas.height = 64;
            const hCtx = hCanvas.getContext('2d');
            hCtx.fillStyle = '#ff4d79';
            hCtx.beginPath();
            const hx = 32, hy = 20;
            hCtx.moveTo(hx, hy + 12);
            hCtx.bezierCurveTo(hx, hy, hx - 18, hy, hx - 18, hy + 12);
            hCtx.bezierCurveTo(hx - 18, hy + 26, hx, hy + 34, hx, hy + 40);
            hCtx.bezierCurveTo(hx, hy + 34, hx + 18, hy + 26, hx + 18, hy + 12);
            hCtx.bezierCurveTo(hx + 18, hy, hx, hy, hx, hy + 12);
            hCtx.fill();
            const heartTexture = new THREE.CanvasTexture(hCanvas);

            const heartMat = new THREE.PointsMaterial({
                size: 0.35,
                map: heartTexture,
                transparent: true,
                opacity: 0.7,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });
            heartParticles = new THREE.Points(heartGeo, heartMat);
            scene.add(heartParticles);

            // --- Sparkle particles ---
            const sparkleCount = 80;
            const sparkleGeo = new THREE.BufferGeometry();
            const sparklePositions = new Float32Array(sparkleCount * 3);
            for (let i = 0; i < sparkleCount; i++) {
                sparklePositions[i * 3] = (Math.random() - 0.5) * 12;
                sparklePositions[i * 3 + 1] = Math.random() * 5 + 0.5;
                sparklePositions[i * 3 + 2] = (Math.random() - 0.5) * 25 - 2;
            }
            sparkleGeo.setAttribute('position', new THREE.BufferAttribute(sparklePositions, 3));
            sparkleMat = new THREE.PointsMaterial({
                size: 0.08,
                color: 0xffffff,
                transparent: true,
                opacity: 0.8,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });
            sparkleParticles = new THREE.Points(sparkleGeo, sparkleMat);
            scene.add(sparkleParticles);

            // --- Petal rain ---
            const petalCount = 25;
            petals3D = [];
            const petalGeo = new THREE.PlaneGeometry(0.12, 0.08);
            for (let i = 0; i < petalCount; i++) {
                const petalMat = new THREE.MeshBasicMaterial({
                    color: new THREE.Color().setHSL(0.95 + Math.random() * 0.05, 0.6, 0.8),
                    transparent: true,
                    opacity: 0.5 + Math.random() * 0.2,
                    side: THREE.DoubleSide
                });
                const petal = new THREE.Mesh(petalGeo, petalMat);
                petal.position.set(
                    (Math.random() - 0.5) * 10,
                    Math.random() * 5 + 3,
                    (Math.random() - 0.5) * 20 - 2
                );
                petal.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);
                petal.userData = {
                    fallSpeed: Math.random() * 0.008 + 0.004,
                    swaySpeed: Math.random() * 0.015 + 0.008,
                    swayAmp: Math.random() * 0.4 + 0.2,
                    rotSpeed: Math.random() * 0.015 + 0.008,
                    initX: petal.position.x
                };
                scene.add(petal);
                petals3D.push(petal);
            }

            // --- Controls ---
            document.addEventListener('keydown', (e) => {
                switch(e.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = true; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = true; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
                    case 'ArrowRight': case 'KeyD': moveRight = true; break;
                }
            });
            document.addEventListener('keyup', (e) => {
                switch(e.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = false; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = false; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
                    case 'ArrowRight': case 'KeyD': moveRight = false; break;
                }
            });

            const btnUp = document.getElementById('btnUp');
            const btnDown = document.getElementById('btnDown');
            const btnLeft = document.getElementById('btnLeft');
            const btnRight = document.getElementById('btnRight');
            const handleTouch = (btn, dir, val) => {
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); dir = true; });
                btn.addEventListener('touchend', (e) => { e.preventDefault(); dir = false; });
                if(btn.id === 'btnUp') { btn.addEventListener('touchstart', ()=>moveForward=true); btn.addEventListener('touchend', ()=>moveForward=false); }
                if(btn.id === 'btnDown') { btn.addEventListener('touchstart', ()=>moveBackward=true); btn.addEventListener('touchend', ()=>moveBackward=false); }
                if(btn.id === 'btnLeft') { btn.addEventListener('touchstart', ()=>moveLeft=true); btn.addEventListener('touchend', ()=>moveLeft=false); }
                if(btn.id === 'btnRight') { btn.addEventListener('touchstart', ()=>moveRight=true); btn.addEventListener('touchend', ()=>moveRight=false); }
            };
            handleTouch(btnUp); handleTouch(btnDown); handleTouch(btnLeft); handleTouch(btnRight);
            animate3D();
        }

        function animate3D() {
            if (!is3DActive) return;
            requestAnimationFrame(animate3D);
            effectTime += 0.016;

            const speed = 0.1; const rotSpeed = 0.03; let isMoving = false;
            if (moveForward) { camera.translateZ(-speed); isMoving = true; }
            if (moveBackward) { camera.translateZ(speed); isMoving = true; }
            if (moveLeft) camera.rotateY(rotSpeed);
            if (moveRight) camera.rotateY(-rotSpeed);

            if (isMoving) {
                walkingTime += 0.05;
                camera.position.y = baseHeight + Math.sin(walkingTime * bobSpeed) * bobAmount;
            } else {
                camera.position.y = THREE.MathUtils.lerp(camera.position.y, baseHeight, 0.1);
            }

            // --- Animate heart particles ---
            if (heartParticles) {
                const hPos = heartParticles.geometry.attributes.position;
                for (let i = 0; i < heartVelocities.length; i++) {
                    hPos.array[i * 3] += heartVelocities[i].x + Math.sin(effectTime + i) * 0.002;
                    hPos.array[i * 3 + 1] += heartVelocities[i].y;
                    hPos.array[i * 3 + 2] += heartVelocities[i].z;
                    if (hPos.array[i * 3 + 1] > 6) {
                        hPos.array[i * 3 + 1] = -0.5;
                        hPos.array[i * 3] = (Math.random() - 0.5) * 10;
                        hPos.array[i * 3 + 2] = camera.position.z + (Math.random() - 0.5) * 10;
                    }
                }
                hPos.needsUpdate = true;
            }

            // --- Animate sparkle twinkle ---
            if (sparkleMat) {
                sparkleMat.opacity = 0.3 + Math.sin(effectTime * 4) * 0.3 + Math.sin(effectTime * 7) * 0.15;
            }

            // --- Animate petals ---
            petals3D.forEach(petal => {
                petal.position.y -= petal.userData.fallSpeed;
                petal.position.x = petal.userData.initX + Math.sin(effectTime * petal.userData.swaySpeed * 60) * petal.userData.swayAmp;
                petal.rotation.x += petal.userData.rotSpeed;
                petal.rotation.z += petal.userData.rotSpeed * 0.7;
                if (petal.position.y < -0.5) {
                    petal.position.y = 5 + Math.random() * 2;
                    petal.position.z = camera.position.z + (Math.random() - 0.5) * 10;
                    petal.userData.initX = (Math.random() - 0.5) * 10;
                }
            });

            // --- Animate lights ---
            if (pinkLight) pinkLight.intensity = 0.6 + Math.sin(effectTime * 2) * 0.25;
            if (purpleLight) purpleLight.intensity = 0.4 + Math.cos(effectTime * 1.5) * 0.25;

            // --- Check end zone ---
            if (camera.position.z < -8) {
                is3DActive = false;
                document.getElementById('world-container').style.display = 'none';
                document.getElementById('joystick-ui').style.display = 'none';
                document.getElementById('instruction-text').style.display = 'none';

                const concertPage = document.getElementById('pageConcert');
                concertPage.classList.remove('hidden');
                concertPage.classList.add('active');
                concertPage.classList.add('fade-in');

                setTimeout(() => { document.getElementById('curtains').classList.add('curtain-open'); }, 500);
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        function goToLovePage() { switchPage('pageConcert', 'page3'); }
        function goToGifts() { switchPage('page3', 'page4'); }
        let finalPrize = "";
        function openGift(element) { if(finalPrize !== "") return; element.classList.add('shaking'); setTimeout(() => { element.classList.remove('shaking'); const prizes = ['‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞ üê∑', '‡∏ä‡∏≤‡∏ö‡∏π üç≤', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô üç£', 'MK ‡∏™‡∏∏‡∏Å‡∏µ‡πâ üç≤', 'BBQ Plaza üê≤']; finalPrize = prizes[Math.floor(Math.random() * prizes.length)]; document.querySelector('.gift-container').style.display = 'none'; document.getElementById('giftSubtitle').style.display = 'none'; document.getElementById('giftTitle').innerText = "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö..."; const today = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }); document.getElementById('voucherPrizeResult').innerText = finalPrize; document.getElementById('voucherDate').innerText = today; document.getElementById('voucherCard').classList.remove('hidden'); confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); }, 800); }
        function shareToLine() { const shareText = `üíñ Voucher Alert! üíñ\n\n‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏Å‡∏¥‡∏ô "${finalPrize}"\n\n‡∏õ‡∏≤‡∏£‡πå‡∏Ñ‡∏Å‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏Å‡∏¥‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß!\n\n(‡∏à‡∏≤‡∏Å Valentines App)`; const encodedText = encodeURIComponent(shareText); const lineUrl = `https://line.me/R/msg/text/?${encodedText}`; window.open(lineUrl, '_blank'); }
    </script>
</body>
</html>